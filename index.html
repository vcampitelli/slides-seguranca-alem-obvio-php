<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="author" content="Vinícius Campitelli">
        <meta name="description" content="Grande parte dos ataques às aplicações Web se deve ao pouco conhecimento de segurança que a equipe de desenvolvimento responsável possuía.
Ou, ainda pior, à falsa sensação de que realmente sabemos como criar sistemas seguros. Isso não é algo tão trivial quanto parece e vai muito além de se proteger de SQL e HTML Injection.
4Veremos então técnicas mais avançadas de defesa, como: proteção à enumeração de usuários, Runtime Application Self-Protection, mitigação de ataques de Rainbow Tables no armazenamento de senhas, entre outros.">

        <title>Sistemas seguros em PHP: estou fazendo certo?</title>

        <link rel="stylesheet" href="reveal.js/css/reveal.css">
        <link rel="stylesheet" href="reveal.js/css/theme/night.css">
        <link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700,700i&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="css/prism.css">
        <link rel="stylesheet" href="css/app.css">

        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = 'reveal.js/' + (window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css');
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>Sistemas seguros em PHP</h1>
                    <h2 class="fragment" style="font-family: Lato; font-style: italic">estou fazendo certo?</h2>
                </section>

                <section>
                    <h2>Quem sou eu?</h2>
                    <ul>
                        <li>Vinícius Campitelli &mdash; <a href="http://vcampitelli.github.io">vcampitelli.github.io</a></li>
                        <li>Arquiteto na <a href="https://mt4.com.br" target="_blank">MT4 Tecnologia</a></li>
                        <li>Sócio-fundador no <a href="https://curseduca.pro" target="_blank">Curseduca</a></li>
                    </ul>
                </section>

                <section>
                    <h2>Agenda</h2>
                    <ul class="no-padding">
                        <li>OWASP Top Ten</li>
                        <li>Gerenciamento de sessão</li>
                        <li>Validação de entradas</li>
                        <li>Armazenamento e políticas de senhas</li>
                        <li>Enumeração de usuários</li>
                        <li>Referências</li>
                    </ul>
                </section>

                <section>
                    <section>
                        <h2>OWASP Top Ten</h2>
                        <p><a href="https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project" target="_blank">owasp.org</a></p>
                    </section>
                    <section>
                        <h3>OWASP Top Ten</h3>
                        <img src="img/owasp-1.png" alt="OWASP Top Ten - Parte 1/2">
                    </section>
                    <section>
                        <h3>OWASP Top Ten</h3>
                        <img src="img/owasp-2.png" alt="OWASP Top Ten - Parte 2/2">
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Gerenciamento de sessão</h2>
                    </section>
                    <section>
                        <h3>Codificação</h3>
                    </section>
                    <section>
                        <p>Regere o ID da sessão no login e logout para mitigar <em>Session Fixation</em></p>
                        <pre><code class="language-php line-numbers">if ($user = $this->loginFrom($_POST)) {
    session_start();
    session_regenerate_id(true); // true para apagar a sessão antiga
}</code></pre>
                    </section>
                    <section>
                        <h3>Configurações</h3>
                    </section>
                    <section>
                        Antes de mais nada...
                        <div class="fragment">
                            <h3>USE HTTPS!</h3>
                        </div>
                    </section>
                    <section>
                        <p>Com <a href="https://letsencrypt.org/" target="_blank">Let's Encrypt</a>, podemos ter<br>certificados SSL gratuitos <span style="color: #f75252">&hearts;</span></p>
                        <br>
                        <ul>
                            <li><a href="https://letsencrypt.org/docs/client-options/" target="_blank">Lista de clientes suportados</a></li>
                            <li>Uso e recomendo o <a href="https://github.com/Neilpang/acme.sh" target="_blank">acme.sh</a></li>
                        </ul>
                    </section>
                    <section>
                        <h4>Configurações do PHP</h4>
                        <pre><code class="language-ini">session.cookie_domain="meusite.com.br"
session.cookie_httponly=On
session.cookie_samesite="Strict"
session.cookie_secure=On
session.name="MYSESSNAME"
session.sid_bits_per_character=6
session.sid_length=48
session.use_only_cookies=On
session.use_strict_mode=On
session.use_trans_sid=Off</code></pre>
                    </section>
                    <section>
                        <h3>Referências</h3>
                        <ul>
                            <li><a href="https://paragonie.com/blog/2015/04/fast-track-safe-and-secure-php-sessions" target="_blank">Paragon IE - The Fast Track to Safe and Secure PHP Sessions</a></li>
                            <li><a href="https://www.php.net/manual/en/session.security.ini.php" target="_blank">Manual do PHP - Securing Session INI Settings</a></li>
                        </ul>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Validação de entradas</h2>
                    </section>
                    <section>
                        <strong>Nunca confie em entradas do usuário!</strong><br><br>
                        <blockquote class="fragment">
                            &#8220;Mas eu estou validando no frontend!&#8221;
                        </blockquote>
                        <cite class="fragment">
                            <small>&mdash; Alguém antes de ter sua aplicação invadida</small>
                        </cite>
                    </section>
                    <section>
                        <ul>
                            <li>
                                Você <strong>pode</strong> utilizar filtros de XSS na entrada
                                <ul>
                                    <li><a href="http://htmlpurifier.org/" target="_blank">HTML Purifier</a></li>
                                    <li><a href="https://github.com/voku/anti-xss" target="_blank">voku/anti-xss</a></li>
                                </ul>
                            </li>
                            <li>
                                Mas <strong>deve</strong> tratar a saída
                                <ul>
                                    <li>Se usar uma ferramenta de <em>templating</em>, verifique sua própria função</li>
                                    <li>
                                        Senão, use a função nativa:
                                        <pre><code class="language-php">htmlentities($str, ENT_QUOTES | ENT_HTML5, $encoding)</code></pre>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <ul>
                            <li>
                                Valide os dados de entrada de acordo com o que você espera para aquele campo (<em>data type</em>)
                                <small>Exemplo: um nome de uma pessoa pode ter apenas letras, espaços, números, hífen e apóstrofo <em>(não esqueça dos acentos!)</em></small>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <ul>
                            <li>Crie uma camada em seu <em>framework</em> que irá validar todos os dados da requisição antes de chegar à camada de negócio</li>
                            <li>Se um campo não possuir um <em>data type</em> estipulado, remova-o da requisição</li>
                        </ul>
                    </section>
                    <section>
                        <ul>
                            <li>
                                Você pode optar por duas abordagens
                                <ol>
                                    <li>Sanitizar a entrada e seguir o processamento com o valor limpo; ou</li>
                                    <li class="margintop">Parar o processamento com <code>HTTP 400 Bad Request</code> <em>(recomendado para aplicações críticas)</em></li>
                                </ol>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>Referências</h3>
                        <ul>
                            <li><a href="https://phpsecurity.readthedocs.io/en/latest/Cross-Site-Scripting-(XSS).html" target="_blank">PHP Security: XSS</a></li>
                            <li><a href="https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet" target="_blank">OWASP: XSS Filter Evasion Cheat Sheet</a></li>
                        </ul>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Armazenamento e políticas de senhas</h2>
                    </section>
                    <section>
                        <h3>Políticas</h3>
                        <ul>
                            <li>Não limite os caracteres permitidos</li>
                            <li>Não coloque um tamanho máximo</li>
                            <li>
                                O tamanho mínimo pode variar de acordo com as necessidades de sua aplicação<br>
                                <small>(de acordo com o <a href="https://csrc.nist.gov/publications/detail/sp/800-132/final" target="_blank">NIST SP800-132</a>, 10 caracteres é o desejável)</small>
                            </li>
                            <li>
                                Crie mecanismos de complexidade<br>
                                <small>Exemplo: ao menos 1 caractere maiúsculo, 1 minúsculo, 1 número e 1 caractere especial</small>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>Armazenamento</h3>
                        <ul>
                            <li>Aplique um algoritmo de hash para transformá-la em um texto com tamanho fixo</li>
                            <li>Utilize um <em>salt</em> específico para aquela senha</li>
                            <li>Criptografe o hash gerado para garantir que você possa recriptografar todas as senhas caso haja vazamento do banco de dados</li>
                        </ul>
                    </section>
                    <section>
                        <p>Se possível, use a <a href="https://paragonie.com/book/pecl-libsodium" target="_blank">libsodium</a>!</p>
                        <p>Uma biblioteca segura, moderna e fácil de usar...<br><em class="fragment">(por mais que os métodos sejam um pouco verbosos)</em></p>
                        <p class="fragment"><br>Sim, estou de olho em você, <code class="small">sodium_crypto_sign_keypair_from_secretkey_and_publickey()</code></p>
                    </section>
                    <section>
                        <h3>Referências</h3>
                        <ul>
                            <li><a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Authentication_Cheat_Sheet.md">OWASP Authentication Cheat Sheet</a></li>
                            <li><a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Password_Storage_Cheat_Sheet.md">OWASP Password Storage Cheat Sheet</a></li>
                            <li><a href="https://crackstation.net/hashing-security.htm" target="_blank">CrackStation: Salted Password Hashing - Doing it Right</a></li>
                            <li><a href="https://github.com/paragonie/password_lock" target="_blank">paragonie/password_lock</a></li>
                            <li><a href="/slides-libsodium-php" target="_blank">Slides da minha palestra sobre a libsodium</a></li>
                            <li><a href="https://en.wikipedia.org/wiki/Rainbow_table" target="_blank">Wikipedia: Rainbow Tables</a></li>
                        </ul>
                    </section>
                </section>

                <section>
                    <section>
                        O que um sistema que rode o código a seguir pode dar de informação a um atacante?
                    </section>
                    <section>
                        <pre><code class="language-php line-numbers">public function login(string $username, string $password) : bool
{
    $user = $this->findByUsername($username);
    if (! $user) {
        return false;
    }
    if (! $this->verifyPassword($password, $user->getPassword())) {
        return false;
    }
    return true;
}</code></pre>
                    </section>
                    <section>
                        <h2>Enumeração de usuários</h2>
                        <p class="fragment">É possível saber que usuários existem em sua aplicação através de <em>Timing attacks</em></p>
                    </section>
                    <section>
                        <pre><code class="language-php line-numbers">public function login(string $username, string $password) : bool
{
    $storedPassword = $this->generateFakePassword();
    $user = $this->findByUsername($username);
    if ($user) {
        $storedPassword = $user->getPassword();
    }
    return ($this->verifyPassword($password, $storedPassword))
        && ($user !== null);
}</code></pre>
                    </section>
                    <section>
                        <p>Será que não estamos exagerando?<br>É realmente possível ver essa diferença?</p><br>
                        <p class="fragment">
                            Vamos testar, então!<br><br>
                            <small>Executando os scripts <code>login-user-enumeration.php</code><br>e <code>login-user-enumeration-fixed.php</code></small>
                        </p>
                    </section>
                    <section>
                        <video controls>
                            <source src="scripts/login-user-enumeration.mp4">
                        </video>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Referências</h2>
                    </section>
                    <section>
                        <h3>Ferramentas</h3>
                        <ul>
                            <li><a href="https://www.metasploit.com/">Metasploit</a></li>
                            <li><a href="https://w3af.org/">w3af</a></li>
                            <li><a href="https://portswigger.net/burp">Burp Suite</a></li>
                            <li><a href="https://pt-br.tenable.com/products/nessus">Nessus</a></li>
                            <li><a href="http://www.openvas.org/">OpenVAS</a></li>
                            <li><a href="https://www.kali.org/">Kali Linux</a></li>
                        </ul>
                    </section>
                    <section>
                        <h3>Leituras</h3>
                        <ul>
                            <li><a href="https://www.owasp.org/">OWASP</a></li>
                            <li><a href="https://paragonie.com/">Paragon Initiative</a></li>
                            <li><a href="https://www.devsecops.org/">devsecops.org</a></li>
                            <li><a href="https://www.bsimm.com/">BSIMM</a></li>
                            <li><a href="https://pt.slideshare.net/few/basic-of-ssdlc/2">SSDLC</a></li>
                        </ul>
                    </section>
                    <section>
                        <h3>Vulnerabilidades</h3>
                        <ul>
                            <li><a href="https://snyk.io/vuln">snyk</a></li>
                            <li><a href="https://cve.mitre.org/">CVE - Mitre</a></li>
                            <li><a href="https://www.cvedetails.com/">CVE Details</a></li>
                        </ul>
                    </section>
                    <section>
                        <h3>Eventos</h3>
                        <ul style="float: left; width: 40%">
                            <li><a href="https://roadsec.com.br/">Roadsec</a></li>
                            <li><a href="https://mindthesec.com.br/">mindthesec</a></li>
                            <li><a href="https://www.h2hc.com.br/h2hc/pt/">H2HC</a></li>
                            <li><a href="http://www.securitybsides.com.br/">BSides</a></li>
                        </ul>
                        <ul style="float: left;">
                            <li><a href="http://www.securityleaders.com.br">Security Leaders</a></li>
                            <li><a href="https://www.ysts.org/">you sh0t the sheriff</a></li>
                            <li><a href="https://garoa.net.br/wiki/P%C3%A1gina_principal">Garoa Hacker Club</a></li>
                        </ul>
                    </section>
                </section>

                <section>
                    <h2>Pontos de atenção</h2>
                    <ul>
                        <li>Proteger uma aplicação Web não é algo trivial</li>
                        <li>Existem muitos outros ataques e técnicas de defesas além dessas</li>
                        <li>Avalie o que faz sentido para seu sistema</li>
                        <li>Utilize técnicas de <a href="https://en.wikipedia.org/wiki/Defense_in_depth_(computing)" target="_blank">defesa em camadas</a></li>
                    </ul>
                </section>

                <section>
                    <h4>Participe de meus<br>treinamentos presenciais<br>de desenvolvimento</h4>
                    <img src="qrcode.png"><br>
                    <a href="https://bit.ly/treinamento-presencial-dev" target="_blank">bit.ly/treinamento-presencial-dev</a>
                </section>

                <section>
                    <h2>Obrigado!</h2>
                    <a href="http://vcampitelli.github.io" target="_blank">vcampitelli.github.io</a></li>
                </section>
            </div>
        </div>

        <script src="reveal.js/js/reveal.js"></script>
        <script>
            Reveal.initialize({
                dependencies: [
                    { src: 'js/prism.js', async: true }
                ],
                slideNumber: true,
                mouseWheel: false,
                history: true,
                overview: false
            });
        </script>
    </body>
</html>
